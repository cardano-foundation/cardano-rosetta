name: CI

on:
  pull_request:
    branches:
      - master

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
        with:
          path: cardano-rosetta
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 14
      - name: Lint and test
        working-directory: ./cardano-rosetta/cardano-rosetta-server
        run: |
          yarn install --offline --frozen-lockfile --logevel=error
          yarn lint
          yarn test
        env:
          PORT: 8080
          LOGGER_LEVEL: debug
          LOGGER_ENABLED: true
          BIND_ADDRESS: 127.0.0.1
          DB_CONNECTION_STRING: postgresql://postgres:notForProduction!@127.0.0.1:5432/cexplorer
          TOPOLOGY_FILE_PATH: test/e2e/utils/topology-test.json
          CARDANOCLI_PATH: cardano-cli
          CARDANO_NODE_PATH: cardano-node
          GENESIS_PATH: test/e2e/utils/mainnet-genesis.json
          CARDANO_NODE_SOCKET_PATH: /tmp/ipc/node.socket
          PAGE_SIZE: 5
          DEFAULT_RELATIVE_TTL: 1000
#      - name: Build Source Images
#        working-directory: ./cardano-rosetta
#        env:
#          DOCKER_BUILDKIT: 1
#        run: ./scripts/build_source_images.sh .
#      - name: Build Local Cardano Rosetta
#        working-directory: ./cardano-rosetta
#        env:
#          DOCKER_BUILDKIT: 1
#        run: docker build
#            --build-arg BUILDKIT_INLINE_CACHE=1
#            --cache-from inputoutput/cardano-rosetta:master
#            -t cardano-rosetta:${{ github.sha }}
#            -f dev.Dockerfile
#            .
      - run: echo ${{ github.ref }} && echo ${{ github.head_ref }} && echo ${{ github.base_ref }}
      - name: Build Cardano Rosetta
        uses: ./cardano-rosetta/.github/actions/build_cardano_rosetta
        with:
          cardano-rosetta-version: ${{ github.ref }}
      - name: Smoke test Cardano Rosetta image
        uses: ./cardano-rosetta/.github/actions/smoke_test_cardano_rosetta
        with:
          cardano-rosetta-version: ${{ github.sha }}
